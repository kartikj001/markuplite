<!-- Author : Kartik Jadhav. Copyrights © 2024, Kartik Jadhav, All rights reserved. Any kind of duplication of work is not allowed. -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarkupLite</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 12px;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #1e1e1e;
      color: #e0e0e0;
    }

    .container {
      text-align: center;
      background-color: #2d2d2d;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      padding: 20px;
      max-width: 100%;
      width: 100%;
      overflow: hidden;
    }

    #imageCanvas {
      border: 1px solid #444;
      display: block;
      margin: 10px auto;
      cursor: crosshair;
      background-color: #2d2d2d;
    }

    .controls {
      margin-top: 10px;
    }

    .controls textarea {
      padding: 10px;
      font-size: 12px;
      margin-bottom: 10px;
      display: block;
      width: calc(100% - 20px);
      max-width: 400px; /* Reduced width */
      margin-left: auto;
      margin-right: auto;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #333;
      color: #e0e0e0;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .controls button,
    #imageUpload,
    #pasteImageBtn {
      padding: 10px 15px;
      font-size: 12px;
      cursor: pointer;
      margin: 5px;
      border: 1px solid #555;
      border-radius: 4px;
      color: #e0e0e0;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
      background-color: #333;
    }

    .controls button.active,
    .controls button:hover,
    #pasteImageBtn:hover,
    #imageUpload:hover {
      background-color: #007bff;
      color: #ffffff;
      border-color: #007bff;
    }

    .controls .button-group {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    .controls .button-group button {
      background-color: #333;
    }

    #imageButtonsContainer {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    #imageButtonsContainer button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(45deg, #ff6b6b, #ffcc6b);
      transition: background 0.3s, transform 0.3s;
    }

    #imageButtonsContainer button:hover {
      background: linear-gradient(45deg, #ff6b6b, #f9a825);
      transform: scale(1.05);
    }

    #copyImageBtn {
      background-color: #333;
      border-color: #555;
      color: #e0e0e0;
    }

    #copyImageBtn:hover {
      background-color: #007bff;
      color: #ffffff;
      border-color: #007bff;
    }

    #welcomeModal {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: #e0e0e0;
      z-index: 1000;
    }

    #welcomeModal .modal-content {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }

    #welcomeModal button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: #ffffff;
      cursor: pointer;
    }

    #welcomeModal button:hover {
      background-color: #0056b3;
    }

    @media (max-width: 600px) {
      .controls {
        margin-top: 5px;
      }
      
      .controls button {
        padding: 8px 12px;
        font-size: 10px;
      }

      #imageCanvas {
        margin: 5px auto;
      }
    }
  </style>
</head>
<body>
  <div id="welcomeModal">
    <div class="modal-content">
      <h2>Welcome to the Markup<i>Lite</i></h2>
      <p>Upload or Paste image from clipboard, add text, draw markups, copy image & send!!.</p>
      <button onclick="closeWelcomeModal()">Get Started</button>
    </div>
  </div>

  <div class="container">
    <h1>Markup<i>Lite</i></h1>

    <!-- File Input to Upload Image -->
    <div class="button-group">
      <input type="file" id="imageUpload" accept="image/*">
      <button id="pasteImageBtn" onclick="pasteImageFromClipboard()">Paste Image</button>
    </div>
    <br>

    <!-- Controls Section -->
    <div class="controls">
      <textarea id="description" rows="4" placeholder="Add Title"></textarea>
      <div class="button-group">
        <button id="addTextBtn" onclick="addTextToImage()">Add Title</button>
        <button id="addMarkupBtn" onclick="enableAddMarkup()">Add Markups</button>
        <button id="addArrowsBtn" onclick="enableAddArrows()">Add Arrows</button>
        <button id="addTextBoxBtn" onclick="enableAddTextBox()">Add Text-Box</button>
        <button id="removeAllMarkupsBtn" onclick="removeAllMarkups()">Remove All Markups</button>
        <button id="undoBtn" onclick="undo()">Undo</button>
      </div>
    </div>

    <!-- Canvas where image and markup will be displayed -->
    <canvas id="imageCanvas"></canvas>
    
    <!-- Button to copy the image -->
    <div id="imageButtonsContainer">
      <button id="copyImageBtn" onclick="copyImageToClipboard()">Copy Image</button>
    </div>
    <p style="text-align:center;"> Copyright © 2024, Kartik Jadhav, All rights reserved.</p>
  </div>

  <script>
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    let uploadedImage = null;
    const circles = [];
    const arrows = [];
    const textBoxes = [];
    let addMode = true;
    let arrowMode = false;
    let textBoxMode = false;
    let startPoint = null;
    let currentTextBox = null;
    const undoStack = [];
    const MAX_UNDO_STACK = 100;
    let circleCount = 1;

    function setCanvasSize(img) {
      const aspectRatio = img.width / img.height;
      const maxWidth = 800;
      const maxHeight = 600;

      if (img.width > img.height) {
        canvas.width = Math.min(maxWidth, img.width);
        canvas.height = canvas.width / aspectRatio;
      } else {
        canvas.height = Math.min(maxHeight, img.height);
        canvas.width = canvas.height * aspectRatio;
      }
    }

    document.getElementById('imageUpload').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      const img = new Image();

      reader.onload = function(e) {
        img.src = e.target.result;
      };

      img.onload = function() {
        uploadedImage = img;
        setCanvasSize(img);
        drawImageWithMarkup();
      };

      reader.readAsDataURL(file);
    });

    function addTextToImage() {
      addStateToUndoStack();
      drawImageWithMarkup();
    }

    function enableAddMarkup() {
      addMode = true;
      arrowMode = false;
      textBoxMode = false;
      highlightButton('addMarkupBtn');
    }

    function enableAddArrows() {
      addMode = false;
      arrowMode = true;
      textBoxMode = false;
      highlightButton('addArrowsBtn');
    }

    function enableAddTextBox() {
      addMode = false;
      arrowMode = false;
      textBoxMode = true;
      highlightButton('addTextBoxBtn');
    }

    function removeAllMarkups() {
      addStateToUndoStack();
      circles.length = 0;
      arrows.length = 0;
      textBoxes.length = 0;
      drawImageWithMarkup();
    }

    function highlightButton(buttonId) {
      document.querySelectorAll('.controls button').forEach(button => {
        button.classList.remove('active');
      });
      document.getElementById(buttonId).classList.add('active');
    }

    function copyImageToClipboard() {
      canvas.toBlob(blob => {
        const item = new ClipboardItem({ 'image/png': blob });
        navigator.clipboard.write([item]).then(() => {
          alert('Image copied to clipboard!');
        });
      });
    }

    function drawImageWithMarkup() {
      if (uploadedImage) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(uploadedImage, 0, 0, canvas.width, canvas.height);

        circles.forEach((circle, index) => {
          ctx.beginPath();
          ctx.arc(circle.x, circle.y, circle.radius, 0, Math.PI * 2);
          ctx.strokeStyle = 'red';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.beginPath();
          ctx.arc(circle.x, circle.y, circle.radius / 3, 0, Math.PI * 2);
          ctx.fillStyle = 'red';
          ctx.fill();

          // Draw number beside the circle in blue
          ctx.font = '12px Arial';
          ctx.fillStyle = 'blue';
          ctx.textAlign = 'left';
          ctx.textBaseline = 'middle';
          ctx.fillText(index + 1, circle.x + circle.radius + 5, circle.y);
        });

        arrows.forEach(arrow => {
          drawArrow(arrow.start, arrow.end);
        });

        textBoxes.forEach(box => {
          ctx.fillStyle = 'black';
          ctx.fillRect(box.x, box.y - 20, box.width, 20);
          ctx.fillStyle = 'white';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.font = '12px Arial';
          ctx.fillText(box.text, box.x + (box.width / 2), box.y - 5);
        });

        const description = document.getElementById('description').value;
        if (description) {
          ctx.fillStyle = 'black';
          const textX = canvas.width / 2;
          const lineHeight = 16;
          const lines = description.split('\n');
          const maxLineWidth = Math.max(...lines.map(line => ctx.measureText(line).width));
          const textHeight = lineHeight * lines.length;

          // Draw black background behind the text
          ctx.fillRect(0, canvas.height - textHeight - 10, canvas.width, textHeight + 10);

          ctx.fillStyle = 'white';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          ctx.font = '12px Arial';

          lines.forEach((line, index) => {
            ctx.fillText(line, textX, canvas.height - textHeight + (lineHeight * index));
          });
        }
      }
    }

    function drawArrow(start, end) {
      const headLength = 10;
      const angle = Math.atan2(end.y - start.y, end.x - start.x);
      ctx.beginPath();
      ctx.moveTo(start.x, start.y);
      ctx.lineTo(end.x, end.y);
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'blue';
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(end.x, end.y);
      ctx.lineTo(end.x - headLength * Math.cos(angle - Math.PI / 6), end.y - headLength * Math.sin(angle - Math.PI / 6));
      ctx.lineTo(end.x - headLength * Math.cos(angle + Math.PI / 6), end.y - headLength * Math.sin(angle + Math.PI / 6));
      ctx.lineTo(end.x, end.y);
      ctx.fillStyle = 'blue';
      ctx.fill();
    }

    function addStateToUndoStack() {
      if (undoStack.length >= MAX_UNDO_STACK) {
        undoStack.shift();
      }
      undoStack.push({ circles: [...circles], arrows: [...arrows], textBoxes: [...textBoxes] });
    }

    function undo() {
      if (undoStack.length > 0) {
        const lastState = undoStack.pop();
        circles.length = 0;
        arrows.length = 0;
        textBoxes.length = 0;
        circles.push(...lastState.circles);
        arrows.push(...lastState.arrows);
        textBoxes.push(...lastState.textBoxes);
        drawImageWithMarkup();
      } else {
        alert("No more actions to undo.");
      }
    }

    function closeWelcomeModal() {
      document.getElementById('welcomeModal').style.display = 'none';
    }

    window.addEventListener('beforeunload', function(event) {
      event.preventDefault();
      event.returnValue = '';
    });

    canvas.addEventListener('mousedown', function(event) {
      if (arrowMode) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        startPoint = { x, y };
      } else if (textBoxMode) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        const text = prompt("Enter text for the text box:");
        if (text) {
          addStateToUndoStack();
          textBoxes.push({ x, y, width: ctx.measureText(text).width + 10, text });
          drawImageWithMarkup();
        }
      }
    });

    canvas.addEventListener('mousemove', function(event) {
      if (arrowMode && startPoint) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        drawImageWithMarkup();
        ctx.beginPath();
        ctx.moveTo(startPoint.x, startPoint.y);
        ctx.lineTo(x, y);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'blue';
        ctx.stroke();
      }
    });

    canvas.addEventListener('mouseup', function(event) {
      if (arrowMode && startPoint) {
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        addStateToUndoStack();
        arrows.push({ start: startPoint, end: { x, y } });
        startPoint = null;
        drawImageWithMarkup();
      }
    });

    canvas.addEventListener('click', function(event) {
      if (arrowMode || textBoxMode) return;

      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const radius = 15;

      if (addMode) {
        addStateToUndoStack();
        circles.push({ x, y, radius });
        circleCount++;
      } else {
        const index = circles.findIndex(circle => {
          const dx = circle.x - x;
          const dy = circle.y - y;
          return Math.sqrt(dx * dx + dy * dy) < radius;
        });
        if (index !== -1) {
          addStateToUndoStack();
          circles.splice(index, 1);
        }
      }

      drawImageWithMarkup();
    });

    function pasteImageFromClipboard() {
      navigator.clipboard.read().then(items => {
        items.forEach(item => {
          if (item.types.includes('image/png')) {
            item.getType('image/png').then(blob => {
              const img = new Image();
              img.src = URL.createObjectURL(blob);
              img.onload = function() {
                uploadedImage = img;
                setCanvasSize(img);
                drawImageWithMarkup();
              };
            });
          }
        });
      });
    }
  </script>
</body>
</html>
